<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meeting Time Arrangement App</title>
  <style>
    /* ==== CSS ==== */
    body {
        font-family: 'Helvetica Neue', sans-serif;
        background: #f9fafb;
        color: #333;
        padding: 20px;
    }
    h1, h2, h3 {
        text-align: center;
        margin-bottom: 10px;
    }
    .page {
        display: none;
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .active {
        display: block;
    }
    input, button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }
    button {
        background: #4f46e5;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
    }
    button:hover {
        background: #4338ca;
    }
    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 20px;
    }
    .slot {
        padding: 10px;
        background: #f1f5f9;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .slot.selected {
        background: #c7d2fe;
    }
    .slot.past {
        background: #e2e8f0;
        color: #aaa;
        pointer-events: none;
    }
    .slot.common {
        background: #34d399;
        color: white;
    }
    .invite-list {
        margin-top: 20px;
    }
    .invite-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f3f4f6;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 6px;
    }
    .signup-prompt, .login-prompt {
        text-align: center;
        margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Meeting Time</h1>

<!-- Login Page -->
<div id="loginPage" class="page active">
  <h2>Login</h2>
  <input type="text" id="loginUsername" placeholder="Username">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
  <div class="signup-prompt">
    <p>Don't have an account?</p>
    <button onclick="goToSignup()">Sign Up</button>
  </div>
</div>

<!-- Signup Page -->
<div id="signupPage" class="page">
  <h2>Sign Up</h2>
  <input type="text" id="signupUsername" placeholder="Username">
  <input type="password" id="signupPassword" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <div class="login-prompt">
    <p>Already have an account?</p>
    <button onclick="goToLogin()">Back</button>
  </div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="page">
  <h2>Dashboard</h2>
  <button onclick="goToCreateMeeting()">Create Meeting</button>
  <button onclick="goToMeetingList()">View Meetings</button>
  <button onclick="logout()">Logout</button>
</div>

<!-- Create Meeting Page -->
<div id="createMeetingPage" class="page">
  <h2>Create Meeting</h2>
  <input type="text" id="meetingTitle" placeholder="Meeting Title">
  <button onclick="createMeeting()">Create</button>
  <button onclick="goToDashboard()">Back</button>
</div>

<!-- Meeting List Page -->
<div id="meetingListPage" class="page">
  <h2>Meetings</h2>
  <div id="meetingList"></div>
  <button onclick="goToDashboard()">Back</button>
</div>

<!-- Meeting Detail Page -->
<div id="meetingDetailPage" class="page">
  <h2>Meeting Details</h2>
  <div id="meetingInfo"></div>
  <div id="calendar"></div>

  <h3>Invite Users</h3>
  <input type="text" id="inviteesInput" placeholder="Invite usernames (comma-separated)">
  <button onclick="addInvitees()">Add Invitees</button>

  <button onclick="saveAvailability()">Save Availability</button>
  <button onclick="goToMeetingList()">Back</button>
</div>

<script>
  // ==== JavaScript ==== 

  function $(id) {
    return document.getElementById(id);
  }

  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    $(pageId).classList.add('active');
  }

  function loadUsers() {
    return JSON.parse(localStorage.getItem('users') || '[]');
  }

  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function loadMeetings() {
    return JSON.parse(localStorage.getItem('meetings') || '[]');
  }

  function saveMeetings(meetings) {
    localStorage.setItem('meetings', JSON.stringify(meetings));
  }

  function signup() {
    const username = $('signupUsername').value.trim();
    const password = $('signupPassword').value;
    if (!username || !password) {
      alert('Please fill all fields');
      return;
    }
    const users = loadUsers();
    if (users.find(u => u.username === username)) {
      alert('Username already exists');
      return;
    }
    users.push({ username, password });
    saveUsers(users);
    alert('Signup successful!');
    goToLogin();
  }

  function login() {
    const username = $('loginUsername').value.trim();
    const password = $('loginPassword').value;
    const users = loadUsers();
    const user = users.find(u => u.username === username && u.password === password);
    if (!user) {
      alert('Invalid username or password');
      return;
    }
    localStorage.setItem('currentUser', username);
    goToDashboard();
  }

  function logout() {
    localStorage.removeItem('currentUser');
    goToLogin();
  }

  function goToSignup() {
    showPage('signupPage');
  }

  function goToLogin() {
    showPage('loginPage');
  }

  function goToDashboard() {
    showPage('dashboardPage');
  }

  function goToCreateMeeting() {
    showPage('createMeetingPage');
  }

  function goToMeetingList() {
    renderMeetingList();
    showPage('meetingListPage');
  }

  function createMeeting() {
    const title = $('meetingTitle').value.trim();
    if (!title) {
      alert('Please fill all fields');
      return;
    }
    const meetings = loadMeetings();
    meetings.push({
      id: 'meeting_' + Date.now(),
      owner: localStorage.getItem('currentUser'),
      title,
      invites: [],
      slots: {}
    });
    saveMeetings(meetings);
    alert('Meeting created!');
    goToDashboard();
  }

  function renderMeetingList() {
    const meetings = loadMeetings();
    const username = localStorage.getItem('currentUser');
    const list = meetings.filter(m => 
      m.owner === username || m.invites.some(i => i.username === username)
    );
    $('meetingList').innerHTML = list.map(m => `
      <div class="invite-item">
        <span>${m.title}</span>
        <button onclick="openMeeting('${m.id}')">Open</button>
        <button onclick="deleteMeeting('${m.id}')">Delete</button>
      </div>
    `).join('');
  }

  function deleteMeeting(meetingId) {
    const meetings = loadMeetings();
    const updatedMeetings = meetings.filter(m => m.id !== meetingId);
    saveMeetings(updatedMeetings);
    alert('Meeting deleted!');
    goToMeetingList();  // Refresh the meeting list view
  }

  let currentMeeting = null;

  function openMeeting(id) {
    const meetings = loadMeetings();
    currentMeeting = meetings.find(m => m.id === id);
    if (!currentMeeting) return;
    renderMeetingDetail();
    showPage('meetingDetailPage');
  }

  function renderMeetingDetail() {
    const username = localStorage.getItem('currentUser');
    const info = `
      <p><strong>Title:</strong> ${currentMeeting.title}</p>
      <p><strong>Owner:</strong> ${currentMeeting.owner}</p>
      <p><strong>Invitees:</strong></p>
      <ul>
        ${currentMeeting.invites.map(i => `
          <li>
            <span>${i.username} (${i.status})</span>
            ${i.username === username && i.status === 'pending' ? `
              <button onclick="respondToInvite('${i.username}', 'accepted')">Accept</button>
              <button onclick="respondToInvite('${i.username}', 'declined')">Decline</button>
            ` : ''}
          </li>
        `).join('')}
      </ul>
    `;
    $('meetingInfo').innerHTML = info;

    renderCalendar();
  }

  function respondToInvite(username, status) {
    const invite = currentMeeting.invites.find(i => i.username === username);
    if (invite) {
      invite.status = status;

      // Save the updated meeting
      const meetings = loadMeetings();
      const idx = meetings.findIndex(m => m.id === currentMeeting.id);
      if (idx > -1) {
        meetings[idx] = currentMeeting;
        saveMeetings(meetings);
        alert(`You have ${status} the invitation!`);
        renderMeetingDetail();  // Refresh the meeting detail page to reflect changes
      }
    }
  }

  function renderCalendar() {
    const calendar = $('calendar');
    calendar.innerHTML = '';
    const now = new Date();
    const startHour = 9;
    const endHour = 15;
    const today = now.toISOString().split('T')[0];

    for (let hour = startHour; hour <= endHour; hour++) {
      const slotTimeStart = new Date(today + 'T' + String(hour).padStart(2, '0') + ':00:00');
      const slotTimeEnd = new Date(today + 'T' + String(hour + 1).padStart(2, '0') + ':00:00');

      const slotKeyStart = slotTimeStart.toISOString();
      const slotKeyEnd = slotTimeEnd.toISOString();

      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.textContent = `${formatTime(slotTimeStart)} - ${formatTime(slotTimeEnd)}`;

      if (slotTimeStart < now) {
        slot.classList.add('past');
      } else {
        slot.onclick = () => toggleSlot(slotKeyStart, slot);
      }

      const username = localStorage.getItem('currentUser');
      if (currentMeeting.slots[username] && currentMeeting.slots[username].includes(slotKeyStart)) {
        slot.classList.add('selected');
      }

      calendar.appendChild(slot);
    }
    calendar.classList.add('calendar');
  }

  function formatTime(date) {
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  function toggleSlot(slotKey, slotDiv) {
    const username = localStorage.getItem('currentUser');
    if (!currentMeeting.slots[username]) {
      currentMeeting.slots[username] = [];
    }
    const idx = currentMeeting.slots[username].indexOf(slotKey);
    if (idx > -1) {
      currentMeeting.slots[username].splice(idx, 1);
      slotDiv.classList.remove('selected');
    } else {
      currentMeeting.slots[username].push(slotKey);
      slotDiv.classList.add('selected');
    }
  }

  function saveAvailability() {
    const meetings = loadMeetings();
    const idx = meetings.findIndex(m => m.id === currentMeeting.id);
    if (idx > -1) {
      meetings[idx] = currentMeeting;
      saveMeetings(meetings);
      alert('Availability saved!');
      findCommonSlots();
    }
  }

  function findCommonSlots() {
    const usernames = [currentMeeting.owner].concat(
      currentMeeting.invites.filter(i => i.status === 'accepted').map(i => i.username)
    );
    const allSlots = usernames.map(u => currentMeeting.slots[u] || []);
    const intersection = allSlots.reduce((a, b) => a.filter(c => b.includes(c)));

    document.querySelectorAll('.slot').forEach(div => {
      const text = div.textContent;
      const slotTime = new Date();
      slotTime.setHours(parseInt(text.split(":")[0]), 0, 0, 0);
      const slotKey = slotTime.toISOString();
      if (intersection.includes(slotKey)) {
        div.classList.add('common');
      }
    });
  }

  function addInvitees() {
    const inviteesText = $('inviteesInput').value.trim();
    if (!inviteesText) {
      alert('Please enter invitees');
      return;
    }
    const invitees = inviteesText.split(',').map(i => i.trim());
    currentMeeting.invites.push(...invitees.map(username => ({ username, status: 'pending' })));
    saveMeetings(loadMeetings());
    alert('Invitees added!');
    renderMeetingDetail();
  }
</script>

</body>
</html>
